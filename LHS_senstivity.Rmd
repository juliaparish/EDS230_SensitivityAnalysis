---
title: "Sensitivity Analysis - Latin Hypercube Sampling"
author: "Group H - Paloma Cartwright, Juliet Cohen, Julia Parish"
date: '2022-04-26'
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Sensitivity Analysis - Latin Hypercube Sampling

This environmental model was completed as an assignment for the course, Environmental Data Science 230 | Environmental Science & Management: Modeling Environmental Systems. The goal of this assignment was to code a function to compute atmosphere condcuctance and to conduct a formal sensitivity analysis using the Latin Hypercube Sampling (LHS) random sampling method. This assignment focuses on developing skills to create a atmospheric conductance model function, utilize the Latin Hypercube Sampling to generate near random sample of parameter values, and then plot the atmospheric conductance values.

## Load Libraries
```{r, message=FALSE}
library(here)
library(SciViews) # ln() function
library(pse)
library(purrr)
```

## 1. Code a function to compute atmospheric conductance

```{r model}
source(here("R/atmcon.R"))
```

## 2. Run `atmcon` model and provide a single estimate of atmospheric conductance for this forest.  

```{r run model}
ac_forest <- atmcon(vm = 250, h = 1000)
ac_forest

ac_forest_rounded <- round(ac_forest[[1]], 2)

print(paste0("The atmospheric conductance for this vegetation is ", 
             ac_forest_rounded, " centimeters per second."))
```
\newpage 
## 3. Conduct a sensitivity analysis
Consider the sensitivity of estimates to uncertainty in the following parameters and inputs:

- *h*
- *kd*
- *k0*
- *v*

### 3.A. Use LHS to generate parameter values for the 4 parameters
```{r lHS}
# define 4 parameters to test
factors = c("vm", "h", "kd", "k")

#define sample size
nsets = 100

# set distributions for defined parameters
# qnorm=windspeed, qunif=height, qnorm=k, qnorm=k0
q = c("qnorm", "qunif", "qnorm", "qnorm")

q.arg = list(list(mean = 250, sd = 30), #windspeed
             list(min = 950, max = 1050), #height
             list(mean = 0.7, sd = 0.07), #k
             list(mean = 0.1, sd = 0.01)) #k0
q.arg

# run LHS and generate samples
sens_ac = LHS(NULL, factors, nsets, q, q.arg) # NULL indicates there is no model

#sens_ac
#summary(sens_ac)
#sens_ac$data


sens_pars <- get.data(sens_ac)
head(sens_pars)
```

### 3.B. Run the atmospheric conductance model, `atmcon`, for LHS derived parameters and return aerodynamic conductances

```{r}
source(here("R/atmcon.R"))

ac_lhs <- pmap(sens_pars, atmcon)
head(ac_lhs[[2]])
```

```{r}
atmospheric_conductances <- ac_lhs %>% 
  map_dfr(`[`, "ac")

atmospheric_conductances
```

### 3.C. Plot conductance estimates in a way that accounts for parameter uncertainty

```{r, fig.cap= "This boxplot shows distribution of atmospheric conducances with given estimated forest parameters"}

plot1 <- ggplot(data = atmospheric_conductances, aes(y = ac)) +
  geom_boxplot(fill='seashell1', color="grey58") +
  geom_text(aes(x = 0.025, y = 32.5, label = "32.59"), stat = "unique", 
            size = 3, color = "slategrey") +
  labs(y = "Atmospheric Conductance (cm/s)",
       title = "Atmospheric Conductance - Forest Parameters",
       subtitle = "Variation in Estimated Conductance Outputs",
       caption = "Data: Modeled values modeled based on parameters estimated using LHS.") +
  theme_minimal() +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) 
plot1
```

### 3.D. Plot conductance estimates against each of your parameters

```{r, fig.cap="Analyzing atompheric conductance parameter sensitivity. Parameters: vm = windspeed, h = vegetation height, kd = constant, k = constant."}
# link LHS object (sens_conductance) to outputs
sens_conductance <- pse::tell(sens_ac, 
                              t(atmospheric_conductances),
                              res.names = "Atmospheric Conductance")

# plot conductance vs params
plot2 <- pse::plotscatter(sens_conductance, 
                 pch = 21, bg= "slateblue", col = "grey58", cex = 0.9)
plot2
```

### 3.E. Estimate the Partial Rank Correlation Coefficients (PRCC)

```{r, fig.cap="The partial rank correlation coefficient (PRCC) of the basic reproduction in model (atmcon) with respect to other model parameters. For each parameter, the absolute value of its PRCC represents the sensitivity of the parameter - the larger the value is, the more sensitive the parameter is to the corresponding parameter. Parameters: vm = windspeed, h = vegetation height, kd = constant, k = constant."}

plot3 <- pse::plotprcc(sens_conductance, col = "slateblue")
plot3
```
\newpage
### 3.F. Discussion

#### What do the results tell about how aerodynamic conductance? 

#### What does it suggest about what you should focus on if you want to reduce uncertainty in aerodymaic conductance estimates? 

#### Does this tell you anything about the sensitivity of plant water use to climate change?





